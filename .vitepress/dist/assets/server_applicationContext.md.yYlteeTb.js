import{_ as e,o as a,c as p,ai as o}from"./chunks/framework.BdTV7y8C.js";const h=JSON.parse('{"title":"Application 和 Context","description":"","frontmatter":{},"headers":[],"relativePath":"server/applicationContext.md","filePath":"server/applicationContext.md"}'),d={name:"server/applicationContext.md"};function i(n,t,r,s,c,l){return a(),p("div",null,[...t[0]||(t[0]=[o(`<h1 id="application-和-context" tabindex="-1">Application 和 Context <a class="header-anchor" href="#application-和-context" aria-label="Permalink to “Application 和 Context”">​</a></h1><p>Midway 的应用会同时对外暴露不同协议，比如 Http，WebSocket 等等，这里每个协议对 Midway 来说都是由独立的组件提供的。</p><p>本项目应用的是 <code>@midwayjs/koa</code>，基于<code>koa</code>一个提供 Http 服务的组件。</p><p>每个使用的 Web 框架会提供自己独特的能力，这些独特的能力都会体现在各自的 上下文（Context）和 应用（Application）之上。</p><p>本项目封装了全局方法/属性便于获取<code>Context</code> <code>Application</code></p><h2 id="application" tabindex="-1">Application <a class="header-anchor" href="#application" aria-label="Permalink to “Application”">​</a></h2><p>Application 是某一个组件中的应用对象，在不同的组件中，可能有着不同的实现。Application 对象上会包含一些统一的方法，这些方法统一来自于 IMidwayApplication 定义。</p><h3 id="获取方式" tabindex="-1">获取方式 <a class="header-anchor" href="#获取方式" aria-label="Permalink to “获取方式”">​</a></h3><p>本项目为了方便获取，为Application封装了全局变量，在<code>onReady</code>生命周期后可以调用到。示例：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>import {app} from &#39;@meadmin/core&#39;;</span></span>
<span class="line"><span>export function getConfig(){</span></span>
<span class="line"><span>   return  app.getConfig()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>}</span></span></code></pre></div><p>Application 具有以下方法</p><table tabindex="0"><thead><tr><th>方法名</th><th>说明</th><th>使用方法</th></tr></thead><tbody><tr><td>getAppDir</td><td>用于获取项目根目录路径</td><td>app.getAppDir()</td></tr><tr><td>getBaseDir</td><td>用于获取项目 TypeScript 基础路径，默认开发中为 src 目录，编译后为 dist 目录。</td><td>app.getBaseDir()</td></tr><tr><td>getEnv</td><td>获取当前项目环境。</td><td>app.getEnv()</td></tr><tr><td>getApplicationContext</td><td>获取当前全局依赖注入容器。</td><td>app.getApplicationContext()</td></tr><tr><td>getConfig</td><td>获取配置。</td><td>app.getConfig()</td></tr><tr><td>getLogger</td><td>获取某个 Logger，不传参数，默认返回 appLogger。</td><td>app.getLogger()</td></tr><tr><td>getCoreLogger</td><td>获取 Core Logger。</td><td>app.getCoreLogger()</td></tr><tr><td>getProjectName</td><td>获取项目名，一般从 package.json 中获取。</td><td>app.getProjectName()</td></tr><tr><td>setAttr &amp; getAttr</td><td>临时的全局数据存储</td><td>app.setAttr(&#39;abc&#39;, {a: 1,b: 2,});app.getAttr(&#39;abc&#39;);</td></tr><tr><td>getNamespace</td><td>通过 getNamespace API ，可以获取到当前 app 归属的组件的 框架的类型（即组件的 namespace）。</td><td>app.getNamespace();</td></tr></tbody></table><p>更多说明请参考<a href="https://midwayjs.org/docs/req_res_app" target="_blank" rel="noreferrer">midway Application 和 Context文档</a></p><div class="info custom-block"><p class="custom-block-title custom-block-title-default">INFO</p><ul><li>&#39;@meadmin/core&#39;的app返回的是项目的<code> Main Application</code>(src/configuration.ts 中第一个引入的 Application 即为主要的 Application) <code>@midwayjs/koa</code></li><li>&#39;@meadmin/core&#39;的app是在<code>onReady</code>生命周期赋值的，使用时请确保<code>onReady</code>生命周期已执行</li><li><code>Midway</code>具有如下生命周期：</li></ul><ol><li>配置文件加载，我们可以在这里去修改配置（onConfigLoad）</li><li>依赖注入容器准备完毕，可以在这个阶段做大部分的事情（onReady）</li><li>服务启动完成，可以拿到 server（onServerReady）</li><li>应用即将关闭，在这里清理资源（onStop） 更多生命周期说明请参考文档：<a href="https://midwayjs.org/docs/lifecycle" target="_blank" rel="noreferrer">midway 生命周期</a></li></ol></div><h2 id="context" tabindex="-1">Context <a class="header-anchor" href="#context" aria-label="Permalink to “Context”">​</a></h2><p>Context 是一个请求级别的对象，在每一次收到用户请求时，框架会实例化一个 Context 对象，</p><p>在 Http 场景中，这个对象封装了这次用户请求的信息，或者其他获取请求参数，设置响应信息的方法，在 WebSocket，Rabbitmq 等场景中，Context 也有各自的属性，以框架的定义为准。</p><p>下面的 API 是每个上下文实现通用的属性或者接口。</p><h3 id="获取方式-1" tabindex="-1">获取方式 <a class="header-anchor" href="#获取方式-1" aria-label="Permalink to “获取方式”">​</a></h3><p>本项目为了方便获取，为context封装了全局获取方法，在任何请求上下文中都可以可以调用到。获取到的context 为 项目的主请求组件<code>@midwayjs/koa</code>组件 的<code>content</code>。获取示例：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>import { getContext } from &#39;@meadmin/core&#39;;</span></span>
<span class="line"><span>export function getConfig(){</span></span>
<span class="line"><span>   ctx = getContext();</span></span>
<span class="line"><span>   //返回上下文的开始实际</span></span>
<span class="line"><span>   return ctx.startTime;</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>下面的 API 是每个上下文实现通用的属性或者接口。</p><table tabindex="0"><thead><tr><th>方法名</th><th>说明</th><th>使用方法</th></tr></thead><tbody><tr><td>requestContext</td><td>Midway 会为每个 Context 挂载一个 requestContext 属性，即请求作用域下的依赖注入容器，用来创建请求作用域下的对象。</td><td>const userService = await ctx.requestContext.getAsync(UserService);</td></tr><tr><td>logger</td><td>请求作用域下的默认 logger 对象，包含上下文数据。</td><td>ctx.logger.info(&#39;xxxx&#39;);</td></tr><tr><td>startTime</td><td>上下文执行开始的时间。</td><td>ctx.startTime</td></tr><tr><td>setAttr &amp; getAttr</td><td>和 app 上的方法相同，这些方法的数据是保存在请求链路中，随着请求销毁，你可以在其中放一些请求的临时数据。</td><td>ctx.setAttr(&#39;abc&#39;, {a: 1, b: 2,});ctx.getAttr(&#39;abc&#39;);</td></tr><tr><td>ctx.getLogger(&#39;custom&#39;);</td><td>获取某个自定义 Logger 对应的上下文日志。</td><td>ctx.getLogger(&#39;custom&#39;)</td></tr><tr><td>getApp</td><td>从 ctx 上获取当前框架类型的 app 对象。</td><td>ctx.getApp();</td></tr></tbody></table><p>更多说明请参考<a href="https://midwayjs.org/docs/req_res_app" target="_blank" rel="noreferrer">midway Application 和 Context文档</a></p><div class="info custom-block"><p class="custom-block-title custom-block-title-default">INFO</p><p><code>Context</code> 利用的<code>AsyncLocalStorage</code>在全局中间件绑定在了请求上下文中</p></div>`,25)])])}const x=e(d,[["render",i]]);export{h as __pageData,x as default};
