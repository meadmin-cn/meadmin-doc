import{_ as n,o as a,c as p,ai as e}from"./chunks/framework.BdTV7y8C.js";const g=JSON.parse('{"title":"其他","description":"","frontmatter":{},"headers":[],"relativePath":"server/other.md","filePath":"server/other.md"}'),i={name:"server/other.md"};function l(c,s,r,t,o,d){return a(),p("div",null,[...s[0]||(s[0]=[e(`<h1 id="其他" tabindex="-1">其他 <a class="header-anchor" href="#其他" aria-label="Permalink to “其他”">​</a></h1><h2 id="权限校验" tabindex="-1">权限校验 <a class="header-anchor" href="#权限校验" aria-label="Permalink to “权限校验”">​</a></h2><p>后台<code>admin</code>接口权限校验，在<code>controller</code>使用<code>@AdminPermission</code>装饰器。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>import { AdminPermission, ApiOperationResponse } from &#39;@/decorators/index.js&#39;;</span></span>
<span class="line"><span>import { User } from &#39;@/entities/user.entity.js&#39;;</span></span>
<span class="line"><span>import { Body, Controller, Inject, Post } from &#39;@midwayjs/core&#39;;</span></span>
<span class="line"><span>import { UserCreateDto } from &#39;../dto/userCreate.dto.js&#39;;</span></span>
<span class="line"><span>import { UserService } from &#39;../service/user.service.js&#39;;</span></span>
<span class="line"><span>import { BaseController } from &#39;./base.controller.js&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/**</span></span>
<span class="line"><span> * 为了防止防火墙禁止PUT、DELETE请求，方便传参，除详情外统一使用post请求。</span></span>
<span class="line"><span> * meadmin对controller做了装饰器继承封装，当以/开头时会使用当前controller前缀地址，不以/开头时会递归继承controller前缀地址</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Controller(&#39;user&#39;)</span></span>
<span class="line"><span>export class UserController extends BaseController {</span></span>
<span class="line"><span>  @Inject()</span></span>
<span class="line"><span>  userService: UserService;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  //接口方法必须加async 方法的接口装饰器值必须/开头</span></span>
<span class="line"><span>  @Post(&#39;/add&#39;)</span></span>
<span class="line"><span>  @ApiOperationResponse({</span></span>
<span class="line"><span>    responseType: User,</span></span>
<span class="line"><span>    summary: &#39;添加用户信息&#39;,</span></span>
<span class="line"><span>  })</span></span>
<span class="line"><span>  @AdminPermission(&#39;UserAdd&#39;)</span></span>
<span class="line"><span>  async add(@Body() createDto: UserCreateDto) {</span></span>
<span class="line"><span>    return this.success(await this.userService.create(createDto));</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><p>前台<code>index</code>接口权限校验，在<code>controller</code>使用<code>@IndexPermission</code>装饰器。前台登录仅校验是否登录，未做过多的权限封装。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>import { ApiOperationResponse, IndexPermission } from &#39;@/decorators/index.js&#39;;</span></span>
<span class="line"><span>import { Controller, Get, Inject } from &#39;@midwayjs/core&#39;;</span></span>
<span class="line"><span>import { User } from &#39;../../../entities/user.entity.js&#39;;</span></span>
<span class="line"><span>import { UserService } from &#39;../service/user.service.js&#39;;</span></span>
<span class="line"><span>import { BaseController } from &#39;./base.controller.js&#39;;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/**</span></span>
<span class="line"><span> * 为了防止防火墙禁止PUT、DELETE请求，规避get请求缓存，统一使用post请求。</span></span>
<span class="line"><span> * meadmin对controller做了装饰器继承封装，当以/开头时会使用当前controller前缀地址，不以/开头时会递归继承controller前缀地址</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Controller(&#39;user&#39;)</span></span>
<span class="line"><span>export class UserController extends BaseController {</span></span>
<span class="line"><span>  @Inject()</span></span>
<span class="line"><span>  userService: UserService;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  //接口方法必须加async 方法的接口装饰器值必须/开头</span></span>
<span class="line"><span>  @Get(&#39;/info&#39;)</span></span>
<span class="line"><span>  @ApiOperationResponse({</span></span>
<span class="line"><span>    responseType: User,</span></span>
<span class="line"><span>    summary: &#39;获取当前用户的信息&#39;,</span></span>
<span class="line"><span>  })</span></span>
<span class="line"><span>  @IndexPermission()</span></span>
<span class="line"><span>  async info() {</span></span>
<span class="line"><span>    const entity = await this.userService.findOne(this.ctx.userInfo.id);</span></span>
<span class="line"><span>    return this.success(entity);</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}</span></span></code></pre></div><h2 id="登录校验" tabindex="-1">登录校验 <a class="header-anchor" href="#登录校验" aria-label="Permalink to “登录校验”">​</a></h2><p>后台<code>admin</code>接口放开登录校验可在<code>src/config/config.default.ts</code>中配置。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>admin: {</span></span>
<span class="line"><span>    login: {</span></span>
<span class="line"><span>      secret: &#39;desec2ec3=ase$&amp;e1#edad#$%%&#39;, //token加密平台标识</span></span>
<span class="line"><span>      expiresIn: 3600000 * 6, //token过期时间ms</span></span>
<span class="line"><span>      renewal: 60000 * 10, //续期时间ms</span></span>
<span class="line"><span>      cacheKey: &#39;admin&#39;, //token使用的缓存key对应cacheManager.clients</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    auth: {</span></span>
<span class="line"><span>      noLoginUrl: [\`/api/admin/login/login\`, \`/api/admin/login/captcha\`, new RegExp(&#39;/api/admin/file/get/.+&#39;)] as Array&lt;string | RegExp&gt;, //无需登录地址，支持字符串或正则</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>  },</span></span></code></pre></div><h2 id="配置和环境变量" tabindex="-1">配置和环境变量 <a class="header-anchor" href="#配置和环境变量" aria-label="Permalink to “配置和环境变量”">​</a></h2><p>本项目配置文件在<code>src/config/config.default.ts</code>中，并根据运行环境加载对应的.env文件。</p><p>如<code>dev</code>命令<code>cross-env NODE_ENV=local npx me-devBootstrap --cleanOutDir --watch --run @midwayjs/mock/app</code>会依次加载 <code>.env\`\`.env.local</code>文件</p><p><code>start</code> 命令<code>cross-env NODE_ENV=prod node ./bootstrap.js</code>会依次加载 <code>.env\`\`.env.prod</code>文件 更多说明请参考<a href="https://midwayjs.org/docs/env_config" target="_blank" rel="noreferrer">midway 文档</a>。</p><p><code>.env</code>环境变量中以<code>VIEW_ADMIN_</code>开头和以<code>VIEW_INDEX_</code>开头的环境变量可分别被 <code>admin</code>及<code>index</code>前台项目读取到。</p><h2 id="多语言" tabindex="-1">多语言 <a class="header-anchor" href="#多语言" aria-label="Permalink to “多语言”">​</a></h2><p>本项目的多语言目录在<code>src/locales</code>中,配置方式如下：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>//src/config/config.default.ts</span></span>
<span class="line"><span>i18n: {</span></span>
<span class="line"><span>  // 默认语言  &quot;zh-cn&quot;</span></span>
<span class="line"><span>  defaultLocale: &#39;zh-cn&#39;,</span></span>
<span class="line"><span>  // used to alter the behaviour of missing keys</span></span>
<span class="line"><span>  missingKeyFn: function (locale, value) {</span></span>
<span class="line"><span>    return value;</span></span>
<span class="line"><span>  },</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  // 把你的翻译文本放到这里</span></span>
<span class="line"><span>  localeTable: {</span></span>
<span class="line"><span>    &#39;zh-cn&#39;: {</span></span>
<span class="line"><span>      validate: {</span></span>
<span class="line"><span>        &#39;string.mobile&#39;: &#39;{{#label}} 必须是一个正确的手机号&#39;,</span></span>
<span class="line"><span>      },</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    &#39;en&#39;: {</span></span>
<span class="line"><span>      default: await import(&#39;../locales/en.json&#39;, { with: { type: &#39;json&#39; } }),</span></span>
<span class="line"><span>      validate: await import(&#39;@midwayjs/validate/locales/en_US.json&#39;, { with: { type: &#39;json&#39; } }),</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>  },</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  missingKeyHandler: (message: string, options?: TranslateOptions) =&gt; (options?.args ? formatText(message, options.args) : message),</span></span>
<span class="line"><span>},</span></span></code></pre></div><p>更多说明请参考<a href="https://midwayjs.org/docs/extensions/i18n" target="_blank" rel="noreferrer">midway文档</a></p><h2 id="日志" tabindex="-1">日志 <a class="header-anchor" href="#日志" aria-label="Permalink to “日志”">​</a></h2><p>调试模式及部署模式，都将日志目录改为本地的 \${app.appDir}/logs/ 目录下</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>//src/config/config.default.ts</span></span>
<span class="line"><span>midwayLogger: {</span></span>
<span class="line"><span>    default: {</span></span>
<span class="line"><span>      transports: {</span></span>
<span class="line"><span>        file: {</span></span>
<span class="line"><span>          dir: resolve(import.meta.dirname, &#39;../../logs&#39;),</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>        error: {</span></span>
<span class="line"><span>          dir: resolve(import.meta.dirname, &#39;../../logs&#39;),</span></span>
<span class="line"><span>        },</span></span>
<span class="line"><span>      },</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>    // ...</span></span>
<span class="line"><span>  },</span></span></code></pre></div><h2 id="缓存" tabindex="-1">缓存 <a class="header-anchor" href="#缓存" aria-label="Permalink to “缓存”">​</a></h2><p>集成@midwayjs/redis@3和@midwayjs/cache-manager@3组件，实现基于redis的缓存支持</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>//src/config/config.default.ts</span></span>
<span class="line"><span>  redis: {</span></span>
<span class="line"><span>    clients: {</span></span>
<span class="line"><span>      cache: {</span></span>
<span class="line"><span>        host: process.env.REDIS_HOST,</span></span>
<span class="line"><span>        port: process.env.REDIS_PORT,</span></span>
<span class="line"><span>        password: process.env.REDIS_PASS,</span></span>
<span class="line"><span>        db: 0,</span></span>
<span class="line"><span>      },</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>  },</span></span>
<span class="line"><span>  cacheManager: {</span></span>
<span class="line"><span>    //缓存配置</span></span>
<span class="line"><span>    clients: {</span></span>
<span class="line"><span>      admin: {</span></span>
<span class="line"><span>        store: createRedisStore(&#39;cache&#39;),</span></span>
<span class="line"><span>      },</span></span>
<span class="line"><span>      index: {</span></span>
<span class="line"><span>        store: createRedisStore(&#39;cache&#39;),</span></span>
<span class="line"><span>      },</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>  },</span></span></code></pre></div><h2 id="静态文件映射" tabindex="-1">静态文件映射 <a class="header-anchor" href="#静态文件映射" aria-label="Permalink to “静态文件映射”">​</a></h2><p>集成 @midwayjs/static-file@3组件，public文件夹下的资源都可以使用/文件名直接访问</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>//src/config/config.default.ts</span></span>
<span class="line"><span>  staticFile: {</span></span>
<span class="line"><span>    dirs: {</span></span>
<span class="line"><span>      default: {</span></span>
<span class="line"><span>        prefix: &#39;/&#39;,</span></span>
<span class="line"><span>        dir: &#39;public&#39;,</span></span>
<span class="line"><span>      },</span></span>
<span class="line"><span>      viewAdmin: {</span></span>
<span class="line"><span>        prefix: &#39;/html/admin/&#39;,</span></span>
<span class="line"><span>        dir: &#39;view/admin/dist&#39;,</span></span>
<span class="line"><span>      },</span></span>
<span class="line"><span>      viewIndex: {</span></span>
<span class="line"><span>        prefix: &#39;/html/index/&#39;,</span></span>
<span class="line"><span>        dir: &#39;view/index/dist&#39;,</span></span>
<span class="line"><span>      },</span></span>
<span class="line"><span>    },</span></span>
<span class="line"><span>  },</span></span></code></pre></div><h2 id="更多" tabindex="-1">更多 <a class="header-anchor" href="#更多" aria-label="Permalink to “更多”">​</a></h2><p>依赖注入、生命周期、Cookies 和 Session、内置服务、Web 路由表、现有装饰器索引、框架错误码、设计模式等更多特性请参考<a href="https://midwayjs.org/docs/container" target="_blank" rel="noreferrer">midway文档</a></p>`,29)])])}const m=n(i,[["render",l]]);export{g as __pageData,m as default};
